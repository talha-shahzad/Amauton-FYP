(()=>{"use strict";const e={cache:{},setCacheData:(t,o,a,n=14400)=>{e.cache[t]||(e.cache[t]=new Map);const s=(new Date).getTime(),r={data:a,created_at:s,exp:s+1e3*n};e.cache[t].set(o,r)},getCacheData:(t,o)=>{if(!e.cache[t])return null;if(!e.cache[t].has(o))return null;const a=e.cache[t].get(o);return a.exp<(new Date).getTime()?(e.cache[t].delete(o),null):a.data},clearOldCacheData:e=>{}};function t(e,t,o){isNaN(+t?.[o])||(e[o]=+t[o])}const o=()=>{try{return crypto.randomUUID()}catch(e){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)))}};const a="https://logs.extension.grabley.net/logapi";class n extends Error{constructor(e){super(e),this.name="AuthorizationError"}}const s=async e=>{const t={"Content-Type":"application/json"};if(e?.token&&(t.authorization=`Bearer ${e.token}`),e?.appInfo?.id){const o={uuid:e.appInfo.id,init:e.appInfo.init,lastAuthorization:e.appInfo.lastAuthorization,mainSwitch:e.mainSwitch,version:e.extensionVersion};t["App-Info"]=btoa(JSON.stringify(o));const a=await(async e=>{const t=(new TextEncoder).encode(e),o=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map((e=>e.toString(16).padStart(2,"0"))).join("")})(o.uuid+"ext");t["App-Hash"]=a}return t};async function r(e,t){const o=await fetch(e,t);if(o.ok){const t=await o.json();if(t)return t;throw new Error(`Can't parse response to JSON!   url: ${e}`)}if(t.showLog){console.log("response: ",o);try{const e=await o.json();console.log("result: ",e)}catch(e){}}throw new Error(`Response status ${o.status}!   url: ${e}`)}async function i(e,t,o,i=null){const c=await s(o),l=i?JSON.stringify(i):null;let u;if(e.includes("/ext-uuid/")?u=await r(a+e,{method:t,headers:c,body:l}):(u=await r("https://extension.grabley.net/api"+e,{method:t,headers:c,body:l}),"/log"===e&&await r(a+e,{method:t,headers:c,body:l})),"success"===u?.Ack)return u;throw"error"===u?.Ack&&"Unauthorized"===u?.msg?new n("Unauthorized"):new Error(`Response from server is not 'success'!   path: ${e}`)}function c(e){let t="https://extension.grabley.net/en/";return e&&("ru"===e?t="https://extension.grabley.net/":"ua"===e&&(t="https://extension.grabley.net/uk/")),t}const l=e=>({mainSwitch:!0,active:!1,language:"en",useCrossBrowserAddressCopying:!1,hidePrime:!1,hideSoldByAmazon:!1,hideItemsWithVariation:!1,onlyCurrentlyUnavailable:!1,hideAdvertisingBlocks:!1,buttonSearchOnWalmart:!0,buttonSearchOnEbay:!0,buttonSearchOnEbay_BuyItNow:!1,buttonSearchOnEbay_ItemLocation_NorthAmerica:!1,showAsin:!0,showBuyBox:!0,getBSR:!0,hideEmptyBSR:!1,maxValBSR:"",minValBSR:"",showBrand:!0,showProductInformation:!0,showCustomerReviewsFilter:!0,showPrime:!0,quickSearchOnEbay:!1,amz_showQuantityOnProductPage:!0,showMargin:!0,amazonFee:15,ebay_button_DefaultFilters:!0,hideDontSold:!1,buttonSearchOnAmazon:!0,ebay_only_FastAndFree:!1,phone:"",ebay_MessageToSeller:"",ebay_show_QuantityAvailable:!0,ebay_show_QuantityItemsSold:!0,ebay_show_Delivery:!0,ebay_show_Returns:!0,ebay_show_Brand:!0,ebay_hide_ItemsByQuantity:!1,ebay_hide_ItemsByQuantity_minQuantity:1,ebay_show_ItemSpecifics:!0,walmartAddButtonSearchOnAmazon:!0,walmartAddButtonSearchOnEbay:!0,walmartAddButtonSearchOnEbay_BuyItNow:!1,walmartAddButtonSearchOnEbay_ItemLocation_NorthAmerica:!1}.hasOwnProperty(e));new Event("click",{bubbles:!0}),new Event("change",{bubbles:!0}),new Event("input",{bubbles:!0});const u=e=>new Promise((t=>setTimeout(t,e)));function d(e){let t=!1;e.offers&&(e.offers.forEach((o=>{if(o.viewed_at)return;if(o.viewed)return;const a=(n=e.language,s=o.link,r=e.appInfo.id,c(n)+s+function(e,t="",o=""){if(e){if("ru"===e)return"";if("ua"===e)return t+"uk"+o}return t+"en"+o}(n,"-")+"/?id="+btoa(JSON.stringify({uuid:r})));var n,s,r;chrome.tabs.create({url:a}),o.viewed=(new Date).getTime(),t=!0})),t&&chrome.storage.local.set({offers:[...e.offers]}))}chrome.contextMenus.removeAll(),chrome.contextMenus.create({id:"Grabley.net",title:"Grabley.net",contexts:["page"]}),chrome.contextMenus.onClicked.addListener((function(e,t){chrome.tabs.create({url:"http://www.grabley.net"})}));const g=864e5,h=chrome.runtime.getManifest().version,m=function(){try{return/Chrome\/([0-9.]+)/.exec(navigator.userAgent)[1]}catch(e){return"I can't determine the browser version"}}(),y={active:!1,user_login:"",display_name:"",days:"0",credentialsLastUpdated:0,token:"",buyerAddress:void 0,showLog:!1,showLogLastUpdated:0,appInfo:{},ping:{lastPing:0},offers:[],ebayOptions:{errorDelayTime:8e4,parsingBlockTime:0,parsingIntervalMaxValue:1e3,parsingIntervalIncStep:50},globalVariables:{amz:{maxCountShowedQuantityOnProductPage:5,countShowedQuantityOnProductPage:0}}},f={mainSwitch:!0,active:!1,language:"en",useCrossBrowserAddressCopying:!1,hidePrime:!1,hideSoldByAmazon:!1,hideItemsWithVariation:!1,onlyCurrentlyUnavailable:!1,hideAdvertisingBlocks:!1,buttonSearchOnWalmart:!0,buttonSearchOnEbay:!0,buttonSearchOnEbay_BuyItNow:!1,buttonSearchOnEbay_ItemLocation_NorthAmerica:!1,showAsin:!0,showBuyBox:!0,getBSR:!0,hideEmptyBSR:!1,maxValBSR:"",minValBSR:"",showBrand:!0,showProductInformation:!0,showCustomerReviewsFilter:!0,showPrime:!0,quickSearchOnEbay:!1,amz_showQuantityOnProductPage:!0,showMargin:!0,amazonFee:15,ebay_button_DefaultFilters:!0,hideDontSold:!1,buttonSearchOnAmazon:!0,ebay_only_FastAndFree:!1,phone:"",ebay_MessageToSeller:"",ebay_show_QuantityAvailable:!0,ebay_show_QuantityItemsSold:!0,ebay_show_Delivery:!0,ebay_show_Returns:!0,ebay_show_Brand:!0,ebay_hide_ItemsByQuantity:!1,ebay_hide_ItemsByQuantity_minQuantity:1,ebay_show_ItemSpecifics:!0,walmartAddButtonSearchOnAmazon:!0,walmartAddButtonSearchOnEbay:!0,walmartAddButtonSearchOnEbay_BuyItNow:!1,walmartAddButtonSearchOnEbay_ItemLocation_NorthAmerica:!1},w=()=>Object.assign({},y,f,{extensionVersion:h,browserVersion:m}),p=(b="option_full",function(e){Object.keys(e).length&&P(b,e)});var b;const _=D("option_changes",((e,t,o=[])=>{for(const[a,n]of Object.entries(e))o.includes(a)?!t[a]&&n&&(t[a]=n):t[a]=n}),void 0,5e3),v=D("fetch_error",((e,t)=>{t.hasOwnProperty("data")||(t.data=[]);let o=t.data.find((t=>t.sourceUrl===e.sourceUrl&&t.informationType===e.informationType));o||(o={informationType:e.informationType,sourceUrl:e.sourceUrl,requests:[],count:0},t.data.push(o));const a={};e.asin&&(a.asin=e.asin),e.id&&(a.id=e.id),e.statusCode&&(a.statusCode=e.statusCode),e.addInfo&&(a.addInfo=e.addInfo),Object.keys(a).length>0&&o.requests.push(a),o.count++}),((e,t=6)=>{if(!e.hasOwnProperty("data"))return!1;let o=!1;return e.data.forEach((e=>{e.count>=t&&(o=!0),e.requests.length>=t&&(o=!0)})),o}),2e3),I=function(){let e=!1;return async function(){if(e)return;e=!0;const t="img/icon-with-bell-128.png";for(let e=0;e<12;e++)await u(500),e%2==0?chrome.action.setIcon({path:"img/icon-48.png"}):chrome.action.setIcon({path:t});chrome.action.setIcon({path:t})}}();async function S(){try{const e=await i("/ext-uuid/ping","GET",w());y.showLog&&console.log("ping response: ",e,new Date);const o=y.ping;o.lastPing=(new Date).getTime();const a=function(e){const o=y.ebayOptions,a=e?.ebay?.options;if(!a)return o;return t(o,a,"parsingInterval"),t(o,a,"parsingIntervalMaxValue"),t(o,a,"parsingIntervalIncStep"),t(o,a,"throttlingTimes"),t(o,a,"maxLengthAdditionalQueue"),t(o,a,"errorDelayTime"),o}(e);await chrome.storage.local.set({ping:o,ebayOptions:a}),function(e,t){if(t.offers&&t.offers.length){const o=e.offers.filter((o=>!!t.offers.find((e=>o.id===e.id))||(e.showLog&&console.log("clear offer: ",o),!1)));t.offers.forEach((t=>{const a=o.find((e=>e.id===t.id));if(a)a.title=t.title,a.created_at=new Date(t.created_at).getTime(),a.expired_at=new Date(t.expired_at).getTime();else{const a={...t};a.created_at=new Date(t.created_at).getTime(),a.expired_at=new Date(t.expired_at).getTime(),o.push(a),e.showLog&&console.log("add offer: ",a)}})),chrome.storage.local.set({offers:o})}else chrome.storage.local.set({offers:[]}),e.showLog&&console.log("no offers in response, clear all offers")}(y,e)}catch(e){y.showLog&&(console.log("ping - fail"),console.log(`${e.name} - ${e.message}`))}}async function L(e,t){y.showLog&&console.log(`Fetching auth data. Context: ${e} (${t}):  ${new Date}`);const o={version:h,context:e,addition:t};let a;try{a=await i("/auth","POST",w(),o)}catch(e){if(e instanceof n){y.showLog&&console.log(`${e.name} - ${e.message}`);const t=y.active||y.user_login;await T(),t&&chrome.storage.local.get("language",(e=>{const t=function(e){let t=c(e)+"profile-en";return e&&("ru"===e?t=c(e)+"profile":"ua"===e&&(t=c(e)+"profile-ua")),t}(e.language);chrome.tabs.create({url:t})}))}else console.log(e)}return!(!a?.data||!a?.token)&&(await async function(e){y.token=e,await chrome.storage.local.set({token:e})}(a.token),await x(a.data),S(),function(){const e={};for(const t in f)l(t)&&(e[t]=f[t]);p(e)}(),!0)}async function O(e,t){let o;y.showLog&&console.log(`Fetching user data. Context: ${e} (${t}):  ${new Date}`);try{o=await i("/user","GET",w())}catch(t){if(t instanceof n)return y.showLog&&console.log(`${t.name} - ${t.message}`),await L(e,"authorizationUser");console.log(t)}return!!o?.data&&(await x(o.data),!0)}async function x(e){const t=!y.active;y.active=!1,"Active"===e.active&&(y.active=!0),y.user_login=e.user_login,y.display_name=e.display_name,y.days=e.days,y.credentialsLastUpdated=(new Date).getTime(),y.user_login&&y.user_login.length>0&&(y.appInfo.lastAuthorization=y.credentialsLastUpdated,console.log("Login success.")),await chrome.storage.local.set(y),t&&y.active&&chrome.tabs.query({},(function(e){for(let t=0;t<e.length;t++){const o=e[t].url;o&&(o.indexOf(".amazon.")>0||o.indexOf(".ebay.")>0||o.indexOf(".walmart.")>0||o.indexOf(".totalelement.")>0)&&chrome.tabs.reload(e[t].id)}}))}async function A(e=0){try{const e=await i("/auth/logout","POST",w());y.showLog&&console.log("logOut response:",e),e?.message&&console.log(e.message)}catch(t){if(t instanceof n){console.log(`${t.name} - ${t.message}`);await L("background","logOut")&&0===e&&A(1)}else console.log(`Can't logout on the website! ${t.message}`);return}await T()}async function T(){y.active=!1,y.user_login="",y.display_name="",y.days="0",y.token="",await chrome.storage.local.set(y),console.log("Logout")}function B(e=!1){let t="img/icon-48x48-not-login.png",o="",a="#707070";(y.active||y.user_login&&y.user_login.length>0)&&(t="img/icon-48.png",parseInt(y.days)<=5&&(o=y.days.toString()),parseInt(y.days)<=1&&(a="#A00000")),y?.offers&&y.offers.length>0?e&&I():chrome.action.setIcon({path:t}),chrome.action.setBadgeText({text:o}),chrome.action.setBadgeBackgroundColor({color:a})}chrome.storage.local.get(null,(async function(e){for(const t in e){const o=e[t];t in y&&(y[t]=o),f[t]=o}async function t(e){try{await i("/ext-uuid/reg","POST",w()),e.registerUUID=(new Date).getTime(),y.showLog&&console.log("registerUUID on server - succes"),await chrome.storage.local.set({appInfo:e})}catch(e){y.showLog&&(console.log("registerUUID on server - fail"),console.log(`${e.name} - ${e.message}`))}}y.globalVariables.amz.maxCountShowedQuantityOnProductPage=5,y.globalVariables.amz.countShowedQuantityOnProductPage=0,y.user_login&&(!y.token||!y.credentialsLastUpdated||y.credentialsLastUpdated+5184e5<(new Date).getTime()?L("background","start"):(!y.active||y.credentialsLastUpdated+g<(new Date).getTime())&&O("background","start")),y.showLog&&y.showLogLastUpdated+36e5<(new Date).getTime()&&(y.showLog=!1,y.showLogLastUpdated=(new Date).getTime(),chrome.storage.local.set({showLog:y.showLog,showLogLastUpdated:y.showLogLastUpdated},(()=>{console.log("showLog = false")}))),y?.appInfo?.id?y.appInfo&&!y.appInfo.registerUUID?t(y.appInfo):y.appInfo&&y.appInfo.registerUUID&&(!function(e){if(y?.ping?.lastPing&&y.ping.lastPing>0&&y.ping.lastPing+g>(new Date).getTime())return!1;return!0}()?B(!0):S()):function(){const e={id:o(),init:(new Date).getTime()};y.user_login&&(e.lastAuthorization=e.init);y.appInfo=e,y.showLog&&console.log("generate new UUID: ",e.id);chrome.storage.local.set({appInfo:e}).then((()=>{t(e)}))}(),B(),d(w())})),chrome.storage.onChanged.addListener((function(e,t){for(const t in e){const o=e[t].newValue;"showLog"===t&&(y[t]=o,y.showLogLastUpdated=(new Date).getTime(),chrome.storage.local.set({showLogLastUpdated:y.showLogLastUpdated})),f[t]=o,"offers"===t&&(y.offers=o,B(!0),d(w()))}B(),function(){const t={};for(const o in e)l(o)&&(t[o]=e[o].newValue);_(t)}()}));const P=async(e,t,o="")=>{if(!y.token)return;const a={type:e,data:t,add_info:{addInfo:o,extensionVersion:h,browserVersion:m}};try{await async function(e,t,o,a=""){try{return await i(e,t,w(),o)}catch(s){if(!(s instanceof n))throw s;y.showLog&&console.log(`${s.name} - ${s.message}`);if(await L("background",a))try{return await i(e,t,w(),o)}catch(e){throw e}}}("/log","POST",a,"sendLog")}catch(e){console.log(`${e}`)}};function D(e,t,o,a){let n,s={};return function(r,i=e,c=a){t(r,s),clearTimeout(n),n=setTimeout((()=>{o?o(s)&&P(i,s):Object.keys(s).length&&P(i,s),s={}}),c)}}function U(){const{maxCountShowedQuantityOnProductPage:e,countShowedQuantityOnProductPage:t}=y.globalVariables.amz;t>e?f.amz_showQuantityOnProductPage&&chrome.storage.local.set({amz_showQuantityOnProductPage:!1}):f.amz_showQuantityOnProductPage||chrome.storage.local.set({amz_showQuantityOnProductPage:!0})}async function k(e,t=0){y.showLog&&console.log("Sending buyer's address to grabley");const o={buffer:{buyerAddress:e}};try{await i("/address","POST",w(),o)}catch(o){if(o instanceof n){y.showLog&&console.log(`${o.name} - ${o.message}`);if(await L("background","send buyer's address to Grabley")&&0===t){if(await k(e,1))return!0}}else console.log(o);throw o}return!0}function C(e,t){JSON.stringify(y.buyerAddress)!==JSON.stringify(e)&&(y.buyerAddress=e,chrome.storage.local.set({buyerAddress:e}),y.showLog&&console.log(`Buyer's address from ${t} add to store:`,e))}function z(...e){y.showLog&&console.log(...e)}chrome.runtime.onMessage.addListener((function(t,o,a){if("pvv-ext-authorization"===t.command&&async function(e,t){y.showLog&&console.log(`Authorization. Context: ${e} (${t}):  ${new Date}`),await O(e,t)}(t.context,t.addition),"pvv-ext-logOut"===t.command&&A(),"pvv-ext-updateBuyerAddressFromGrabley"===t.command&&async function(){let e;try{e=await async function(){y.showLog&&console.log("Getting buyer's address from grabley");let e;try{e=await i("/address","GET",w())}catch(e){return void(e instanceof n?(y.showLog&&console.log(`${e.name} - ${e.message}`),L("background","get buyer's address from Grabley")):console.log(e))}return JSON.parse(e?.data?.buffer)?.buyerAddress}()}catch(e){y.showLog&&console.log(`Can't get buyer's address from Grabley: ${e.message}`)}e&&C(e,"grabley")}(),"pvv-ext-setBuyerAddress"===t.command){const e=t.buyerAddress;if(C(e,"content"),t.useCrossBrowserAddressCopying&&y.token)return k(e).then((()=>{a({success:!0})})).catch((e=>{a({success:!1})})),!0;a({success:!0})}"pvv-ext-sendLog"===t.command&&P(t.type,t.data,t.addInfo),"pvv-ext-sendLog-amz-fetch-error"===t.command&&v(t,"error_amz_fetch",2e3),"pvv-ext-sendLog-ebay-fetch-error"===t.command&&v(t,"error_ebay_fetch",2e3),"pvv-ext-sendLog-ebay-block-parsing"===t.command&&function(e,t){const o=y.ebayOptions;o.parsingBlockTime=(new Date).getTime()+o.errorDelayTime,z("ebay - block parsing until time:",new Date(o.parsingBlockTime).toLocaleTimeString());const a=o.parsingInterval?o.parsingInterval:e.parsingInterval;a<o.parsingIntervalMaxValue&&(o.parsingInterval=a+o.parsingIntervalIncStep,z("ebay - incresed parsing interval, new value:",o.parsingInterval));chrome.storage.local.set({ebayOptions:o}),P("error_ebay_fetch_access_denied",{sourceUrl:t,options:o})}(t.currentEbayOptions,t.sourceUrl),"pvv-ext-setCacheData"===t.command&&e.setCacheData(t.cacheType,t.cacheKey,t.data),"pvv-ext-getCacheData"===t.command&&a(e.getCacheData(t.cacheType,t.cacheKey)),t.command,"pvv-ext-sendPing"===t.command&&S(),"pvv-ext-amz-increaseCountShowedQuantityOnProductPage"===t.command&&(y.globalVariables.amz.countShowedQuantityOnProductPage++,U())})),U(),chrome.tabs.onActivated.addListener((e=>{chrome.tabs.query({},(t=>{for(let o=0;o<t.length;o++){const a=t[o];if(a?.id){const t=a.url;t&&t.indexOf(".ebay.")>0&&chrome.tabs.sendMessage(a.id,{command:"pvv-ext-onActivatedTabChanged",isActiveTab:a.id===e.tabId}).catch((e=>{}))}}}))}))})();